From e715107c20bfa946a4555a9bde1f1da46ed3d7c9 Mon Sep 17 00:00:00 2001
From: Manoj Srivastava <srivasta@golden-gryphon.com>
Date: Mon, 28 Apr 2014 15:47:58 -0700
Subject: [PATCH 1/2] debcherry fixup patch

6dc310e [topc--base64fix]: base64_decode_multichunk_and_speedup.diff
	 - no changes against upstream or conflicts
53a7df0 [topic--debian]: Added manual pages for all binaries.
	 - extra changes or conflicts
2020262 Make sure the autoloads files are generated in the right place
	 - no changes against upstream or conflicts
7662c40 [topic--debian]: Do not rely on absolute path
	 - extra changes or conflicts
---
 lisp/Makefile.in    |   4 +-
 src/Makefile.in     |   9 +++++
 src/base64-decode.1 |  50 +++++++++++++++++++++++++
 src/base64-decode.c | 105 ++++++++++++++++++++++++++++++----------------------
 src/base64-encode.1 |  51 +++++++++++++++++++++++++
 src/base64-encode.c |   3 +-
 src/qp-decode.1     |  51 +++++++++++++++++++++++++
 src/qp-decode.c     |   9 +++--
 src/qp-encode.1     |  51 +++++++++++++++++++++++++
 src/qp-encode.c     |   5 ++-
 10 files changed, 286 insertions(+), 52 deletions(-)
 create mode 100644 src/base64-decode.1
 create mode 100644 src/base64-encode.1
 create mode 100644 src/qp-decode.1
 create mode 100644 src/qp-encode.1

diff --git a/lisp/Makefile.in b/lisp/Makefile.in
index 06dccaf..0ab109b 100644
--- a/lisp/Makefile.in
+++ b/lisp/Makefile.in
@@ -130,12 +130,14 @@ version.txt:
 # under Windows.  We remove the CRs.
 # Solaris 8's tr -d '\r' removes r's so we use '\015' instead.
 # the echo command can also emit CRs.
+# Since Debian compiles the files on the fly on the target machine,
+# Do not depend on the abslute file path of the source directory to exist
 vm-autoloads.el: $(SOURCES:%=@srcdir@/%)
 	-$(RM) -f $@
 	echo > $@
 	(build_dir="`pwd`"; cd "@srcdir@"; \
 	 "$(EMACS_PROG)" $(FLAGS) -l autoload \
-		-f vm-built-autoloads "@abs_builddir@/$@" "`pwd`")
+		-f vm-built-autoloads "`pwd`/$@" "`pwd`")
 	echo "(custom-add-load 'vm 'vm-cus-load)" | tr -d '\015' >> $@
 	echo "(setq vm-configure-datadir \"${datadir}\")" | tr -d '\015' >> $@
 	echo "(setq vm-configure-pixmapdir \"${pixmapdir}\")" | tr -d '\015' >> $@
diff --git a/src/Makefile.in b/src/Makefile.in
index 437626f..ef773a6 100644
--- a/src/Makefile.in
+++ b/src/Makefile.in
@@ -8,6 +8,8 @@ SOURCES = $(wildcard *.c)
 
 OBJECTS = $(SOURCES:.c=.o)
 
+MANS = $(wildcard *.1)
+
 ##############################################################################
 # location of required programms
 prefix = @prefix@
@@ -16,11 +18,13 @@ MKDIR = @MKDIR@
 RM   = @RM@
 INSTALL = @INSTALL@
 INSTALL_PROGRAM = @INSTALL_PROGRAM@
+INSTALL_DATA   = @INSTALL_DATA@
 
 prefix = @prefix@
 top_srcdir = @top_srcdir@
 srcdir = @srcdir@
 bindir= @bindir@
+mandir= @mandir@
 
 ##############################################################################
 all: $(SOURCES:.c=)
@@ -31,6 +35,11 @@ install:
 	  echo "Installing $$i in $(DESTDIR)$(bindir)" ;           \
           $(INSTALL_PROGRAM) $$i "$(DESTDIR)$(bindir)" ;           \
         done ;
+	@test -d $(DESTDIR)$(mandir)      ||                        \
+	    mkdir -p -m 0755 "$(DESTDIR)$(mandir)/man1";            \
+	 for i in $(MANS) ; do                                      \
+	   $(INSTALL_DATA) $$i "$(DESTDIR)$(mandir)/man1" ;         \
+	done
 	@echo VM helper binaries successfully installed\!
 
 ##############################################################################
diff --git a/src/base64-decode.1 b/src/base64-decode.1
new file mode 100644
index 0000000..4ba903c
--- /dev/null
+++ b/src/base64-decode.1
@@ -0,0 +1,50 @@
+.\"                             -*- Mode: Nroff -*- 
+.\" Copyright (C) 2000 Manoj Srivastava <srivasta@debian.org>.
+.\"
+.\" Permission is granted to make and distribute verbatim copies of
+.\" this manual provided the copyright notice and this permission notice
+.\" are preserved on all copies.
+.\" 
+.\" Permission is granted to copy and distribute modified versions of this
+.\" manual under the conditions for verbatim copying, provided that the entire
+.\" resulting derived work is distributed under the terms of a permission
+.\" notice identical to this one.
+.\" 
+.\" Permission is granted to copy and distribute translations of this manual
+.\" into another language, under the above conditions for modified versions,
+.\" except that this permission notice may be stated in a translation approved
+.\" by the Author.
+.\"
+.\" Author: Manoj Srivastava
+.\"
+.\" arch-tag: e94acb5a-38da-416b-b01d-9196c0836599
+.\"
+.TH BASE64\-DECODE 1 "Sep 2 2000" "Debian" "Debian GNU/Linux manual"
+.SH NAME 
+base64\-decode \- Fast BASE64 decoder
+.SH SYNOPSIS
+.B base64\-decode 
+< 
+.I base64\-encoded data
+> 
+.I converted output
+.SH DESCRIPTION
+The
+.B base64\-decode
+utility takes BASE64 data on the standard input and converts
+it to the  standard output. 
+.PP
+This manual page was written for the Debian GNU/Linux distribution
+because the original program does not have a manual page.
+.SH OPTIONS
+.B base64\-encode
+does not take any arguments or options.
+.SH BUGS
+None known.
+.SH SEE ALSO
+.I base64\-encode (1)
+.SH AUTHORS
+.B base64\-decode
+was written by Kyle Jones. and placed by him into the public domain.
+This manual page was written by Manoj Srivastava <srivasta@debian.org>,
+for the Debian GNU/Linux system.
diff --git a/src/base64-decode.c b/src/base64-decode.c
index d0d3b9a..1b026f7 100644
--- a/src/base64-decode.c
+++ b/src/base64-decode.c
@@ -4,6 +4,7 @@
 
 #include <stdlib.h>
 #include <stdio.h>
+#include <stdlib.h>
 
 #ifdef _WIN32
 #ifndef WIN32
@@ -19,10 +20,10 @@
 unsigned char alphabet[64] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
 
 int
-main()
+main(void)
 {
-	static char inalphabet[256], decoder[256];
-	int i, bits, c, char_count, errors = 0;
+    static char inalphabet[256], decoder[256];
+    int i, bits, char_count, errors = 0;
 
 #ifdef WIN32
 	_setmode( _fileno(stdout), _O_BINARY);
@@ -32,46 +33,62 @@ main()
 	inalphabet[alphabet[i]] = 1;
 	decoder[alphabet[i]] = i;
 	}
+#define BUFLEN 72*500 // must be multiple of 4
 
-	char_count = 0;
-	bits = 0;
-	while ((c = getchar()) != EOF) {
-	if (c == '=')
-	  break;
-	if (c > 255 || ! inalphabet[c])
-	  continue;
-	bits += decoder[c];
-	char_count++;
-	if (char_count == 4) {
-		putchar((bits >> 16));
-		putchar(((bits >> 8) & 0xff));
-		putchar((bits & 0xff));
-		bits = 0;
-		char_count = 0;
-	} else {
-		bits <<= 6;
-	}
-	}
-	if (c == EOF) {
-	if (char_count) {
-		fprintf(stderr, "base64 encoding incomplete: at least %d bits truncated",
-			((4 - char_count) * 6));
-		errors++;
-	}
-	} else { /* c == '=' */
-	switch (char_count) {
-	  case 1:
-		fprintf(stderr, "base64 encoding incomplete: at least 2 bits missing");
-		errors++;
-		break;
-	  case 2:
-		putchar((bits >> 10));
-		break;
-	  case 3:
-		putchar((bits >> 16));
-		putchar(((bits >> 8) & 0xff));
-		break;
-	}
-	}
-	exit(errors ? 1 : 0);
+    int len;
+    char buf[BUFLEN];
+    char outbuf[BUFLEN];
+
+    while(!feof(stdin)) {
+        unsigned char c;
+
+        int pos=0;
+        char *out=outbuf;
+        len=fread(buf, sizeof(c), BUFLEN, stdin);
+        if(!len) continue;
+
+cont_buffer:
+        char_count = 0;
+        bits = 0;
+        while(pos<len) {
+            c=buf[pos++];
+            if (c == '=')
+                break;
+            if (! inalphabet[c])
+                continue;
+            bits += decoder[c];
+            char_count++;
+            if (char_count == 4) {
+                *out++ = ((bits >> 16));
+                *out++ = (((bits >> 8) & 0xff));
+                *out++ = ((bits & 0xff));
+                bits = 0;
+                char_count = 0;
+            } else {
+                bits <<= 6;
+            }
+        }
+        switch (char_count) {
+            case 1:
+                fprintf(stderr, "base64-decode: base64 encoding incomplete: at least 2 bits missing");
+                errors++;
+                break;
+            case 2:
+                *out++ = ((bits >> 10));
+                break;
+            case 3:
+                *out++ = ((bits >> 16));
+                *out++ = (((bits >> 8) & 0xff));
+                break;
+            case 0:
+                break;
+            default:
+                fprintf(stderr, "base64-decode: base64 encoding incomplete: at least %d bits truncated",
+                        ((4 - char_count) * 6));
+        }
+        if(pos<len) // did not proceed the whole thing, continue
+            goto cont_buffer;
+        fwrite(outbuf, sizeof(char), (out-outbuf), stdout);
+    }
+    exit(errors ? 1 : 0);
 }
diff --git a/src/base64-encode.1 b/src/base64-encode.1
new file mode 100644
index 0000000..ba0e95a
--- /dev/null
+++ b/src/base64-encode.1
@@ -0,0 +1,51 @@
+.\"                             -*- Mode: Nroff -*- 
+.\" Copyright (C) 2000 Manoj Srivastava <srivasta@debian.org>.
+.\"
+.\" Permission is granted to make and distribute verbatim copies of
+.\" this manual provided the copyright notice and this permission notice
+.\" are preserved on all copies.
+.\" 
+.\" Permission is granted to copy and distribute modified versions of this
+.\" manual under the conditions for verbatim copying, provided that the entire
+.\" resulting derived work is distributed under the terms of a permission
+.\" notice identical to this one.
+.\" 
+.\" Permission is granted to copy and distribute translations of this manual
+.\" into another language, under the above conditions for modified versions,
+.\" except that this permission notice may be stated in a translation approved
+.\" by the Author.
+.\"
+.\" Author: Manoj Srivastava
+.\"
+.\" arch-tag: 6563f4a9-302a-4d17-986a-42be5fb1d1c9
+.\"
+.TH BASE64\-ENCODE 1 "Sep 2 2000" "Debian" "Debian GNU/Linux manual"
+.SH NAME 
+base64\-encode \- Fast Base 64 encoder
+.SH SYNOPSIS
+.B base64\-encode 
+< 
+.I input 
+> 
+.I base64\-encoded output
+.SH DESCRIPTION
+The
+.B base64\-encode
+utility takes arbitrary data on the standard input and converts
+it to BASE64 data on standard output. UNIX's newline convention is
+used, i.e. one ASCII control-j (10 decimal). 
+.PP
+This manual page was written for the Debian GNU/Linux distribution
+because the original program does not have a manual page.
+.SH OPTIONS
+.B base64\-encode
+does not take any arguments or options.
+.SH BUGS
+None known.
+.SH SEE ALSO
+.I base64\-decode (1)
+.SH AUTHORS
+.B base64\-encode
+was written by Kyle Jones. and placed by him into the public domain.
+This manual page was written by Manoj Srivastava <srivasta@debian.org>,
+for the Debian GNU/Linux system.
diff --git a/src/base64-encode.c b/src/base64-encode.c
index fd146fa..d9c6651 100644
--- a/src/base64-encode.c
+++ b/src/base64-encode.c
@@ -8,6 +8,7 @@
 
 #include <stdlib.h>
 #include <stdio.h>
+#include <stdlib.h>
 
 #ifdef _WIN32
 #ifndef WIN32
@@ -23,7 +24,7 @@
 unsigned char alphabet[64] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
 
 int
-main()
+main(void)
 {
 	int cols, bits, c, char_count;
 
diff --git a/src/qp-decode.1 b/src/qp-decode.1
new file mode 100644
index 0000000..a9a60d8
--- /dev/null
+++ b/src/qp-decode.1
@@ -0,0 +1,51 @@
+.\"                             -*- Mode: Nroff -*- 
+.\" Copyright (C) 2000 Manoj Srivastava <srivasta@debian.org>.
+.\"
+.\" Permission is granted to make and distribute verbatim copies of
+.\" this manual provided the copyright notice and this permission notice
+.\" are preserved on all copies.
+.\" 
+.\" Permission is granted to copy and distribute modified versions of this
+.\" manual under the conditions for verbatim copying, provided that the entire
+.\" resulting derived work is distributed under the terms of a permission
+.\" notice identical to this one.
+.\" 
+.\" Permission is granted to copy and distribute translations of this manual
+.\" into another language, under the above conditions for modified versions,
+.\" except that this permission notice may be stated in a translation approved
+.\" by the Author.
+.\"
+.\" Author: Manoj Srivastava
+.\"
+.\" arch-tag: cfe27e82-b7a5-4171-bef6-f7bc28306374
+.\"
+.TH QP\-DECODE 1 "Sep 2 2000" "Debian" "Debian GNU/Linux manual"
+.SH NAME 
+qp\-decode \- Fast Quoted Printable decoder
+.SH SYNOPSIS
+.B qp\-decode 
+< 
+.I qp\-encoded data
+> 
+.I converted output
+.SH DESCRIPTION
+The
+.B qp\-decode
+utility takes Quoted Printable data on the standard input and converts
+it to the  standard output. 
+.PP
+This manual page was written for the Debian GNU/Linux distribution
+because the original program does not have a manual page.
+.SH OPTIONS
+.B qp\-encode
+does not take any arguments or options.
+.SH BUGS
+None known.
+.SH SEE ALSO
+.I qp\-encode (1)
+.SH AUTHORS
+.B qp\-decode
+was written by Kyle Jones. and placed by him into the public domain.
+This manual page was written by Manoj Srivastava <srivasta@debian.org>,
+for the Debian GNU/Linux system.
+
diff --git a/src/qp-decode.c b/src/qp-decode.c
index 0d6eaa1..9861f7b 100644
--- a/src/qp-decode.c
+++ b/src/qp-decode.c
@@ -5,6 +5,7 @@
 #include <stdlib.h>
 #include <stdio.h>
 #include <string.h>
+#include <stdlib.h>
 
 #ifdef _WIN32
 #ifndef WIN32
@@ -17,11 +18,11 @@
 #include <fcntl.h>
 #endif
 
-char *hexdigits  = "0123456789ABCDEF";
-char *hexdigits2 = "0123456789abcdef";
+const char *hexdigits  = "0123456789ABCDEF";
+const char *hexdigits2 = "0123456789abcdef";
 
 int
-main()
+main(void)
 {
     char line[2000], *start, *stop, *copy;
     char *d1, *d2, c;
@@ -90,7 +91,7 @@ main()
 		for (stop++; *stop && (*stop == ' ' || *stop == '\t'); stop++)
 		    ;
 	    } else {
-		fprintf(stderr, "Error: line %d: '%c' is something other than line break or hex digit after = in quoted-printable encoding\n", lineno, *stop);
+                fprintf(stderr, "Error: qp-decode: line %d: '%c' is something other than line break or hex digit after = in quoted-printable encoding\n", lineno, *stop);
 		putchar('=');
 		putchar(*stop);
 		stop++;
diff --git a/src/qp-encode.1 b/src/qp-encode.1
new file mode 100644
index 0000000..c3dc52b
--- /dev/null
+++ b/src/qp-encode.1
@@ -0,0 +1,51 @@
+.\"                             -*- Mode: Nroff -*- 
+.\" Copyright (C) 2000 Manoj Srivastava <srivasta@debian.org>.
+.\"
+.\" Permission is granted to make and distribute verbatim copies of
+.\" this manual provided the copyright notice and this permission notice
+.\" are preserved on all copies.
+.\" 
+.\" Permission is granted to copy and distribute modified versions of this
+.\" manual under the conditions for verbatim copying, provided that the entire
+.\" resulting derived work is distributed under the terms of a permission
+.\" notice identical to this one.
+.\" 
+.\" Permission is granted to copy and distribute translations of this manual
+.\" into another language, under the above conditions for modified versions,
+.\" except that this permission notice may be stated in a translation approved
+.\" by the Author.
+.\"
+.\" Author: Manoj Srivastava
+.\"
+.\"  arch-tag: bc2b7485-8846-4a92-9e54-8fd22a778663
+.\"
+.TH QP\-ENCODE 1 "Sep 2 2000" "Debian" "Debian GNU/Linux manual"
+.SH NAME 
+qp\-encode \- Fast Quoted Printable encoder
+.SH SYNOPSIS
+.B qp\-encode 
+< 
+.I input 
+> 
+.I qp\-encoded output
+.SH DESCRIPTION
+The
+.B qp\-encode
+utility takes arbitrary data on the standard input and converts
+it to Quoted Printable data on standard output.
+.PP
+This manual page was written for the Debian GNU/Linux distribution
+because the original program does not have a manual page.
+.SH OPTIONS
+.B qp\-encode
+does not take any arguments or options.
+.SH BUGS
+None known.
+.SH SEE ALSO
+.I qp\-decode (1)
+.SH AUTHORS
+.B qp\-encode
+was written by Kyle Jones. and placed by him into the public domain.
+This manual page was written by Manoj Srivastava <srivasta@debian.org>,
+for the Debian GNU/Linux system.
+
diff --git a/src/qp-encode.c b/src/qp-encode.c
index e5796d0..8014d02 100644
--- a/src/qp-encode.c
+++ b/src/qp-encode.c
@@ -8,6 +8,7 @@
 
 #include <stdlib.h>
 #include <stdio.h>
+#include <stdlib.h>
 
 #ifdef _WIN32
 #ifndef WIN32
@@ -20,10 +21,10 @@
 #include <fcntl.h>
 #endif
 
-char *hexdigits  = "0123456789ABCDEF";
+const char *hexdigits  = "0123456789ABCDEF";
 
 int
-main()
+main(void)
 {
 	int c;
 	int cols = 0;
-- 
2.0.0.rc0

